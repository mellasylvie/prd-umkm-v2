/**
 * Core Philosophy:
 * This ruleset establishes a security model where UMKM profiles and their associated products are publicly readable,
 * allowing any visitor to browse the catalog. However, all write operations (creating, updating, deleting) are
 * strictly controlled by the owner of the UMKM profile. Templates for minisites and promotions
 * are treated as global, read-only assets.
 *
 * Data Structure:
 * - /users/{userId}: Stores user-specific data, accessible only by the authenticated user.
 * - /umkm_profiles/{umkmProfileId}: Top-level collection for all UMKM business profiles.
 *   - /products/{productId}: Subcollection for products belonging to a specific UMKM.
 *   - /visitor_insights/{visitorInsightId}: Subcollection for private analytics for a specific UMKM.
 * - /minisite_templates/{templateId}: Global, read-only collection of site templates.
 * - /promotion_templates/{templateId}: Global, read-only collection of promotion templates.
 *
 * Key Security Decisions:
 * - Public Read, Owner-Only Write: UMKM profiles and products are world-readable to facilitate a public marketplace.
 *   Writes are locked down to the profile owner via the 'ownerId' field.
 * - Private Analytics & User Data: '/visitor_insights' and '/users' are private.
 *   Access is strictly limited to the authenticated owner.
 * - Read-Only Global Assets: The template collections are completely locked down from client writes to protect
 *   shared application resources.
 * - Denormalization for Authorization: The rules rely on 'ownerId' and 'umkmId' fields to validate
 *   ownership and relational integrity without needing costly cross-document 'get' calls in most cases.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //=========== Helper Functions ===========//

    /**
     * Checks if the UID of the authenticated user matches the provided userId.
     * This is the core of the ownership model.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * Checks ownership of the parent UmkmProfile document.
     */
    function isUmkmOwner(umkmProfileId) {
      return isOwner(get(/databases/$(database)/documents/umkm_profiles/$(umkmProfileId)).data.ownerId);
    }

    //=========== Collection Rules ===========//
    
    /**
     * @description Controls access to user data. Only the owner can read or write their data.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    /**
     * @description Controls access to UMKM profiles. Profiles are public to read but can only be modified by their owner.
     * @path /umkm_profiles/{umkmProfileId}
     */
    match /umkm_profiles/{umkmProfileId} {
      allow get, list: if true;

      // Allow create if the user is signed in and the ownerId in the new document matches their UID.
      allow create: if isSignedIn() && isOwner(request.resource.data.ownerId);
      
      // Allow update/delete if the user is the owner of the existing document.
      allow update, delete: if isOwner(resource.data.ownerId);

      /**
       * @description Controls access to products within a UMKM profile. Publicly readable, owner-writable.
       * @path /umkm_profiles/{umkmProfileId}/products/{productId}
       */
      match /products/{productId} {
        allow get, list: if true;

        // Writes are allowed if the user owns the parent UMKM profile.
        // The umkmId in the document must also match the parent path.
        allow create: if isUmkmOwner(umkmProfileId) && request.resource.data.umkmProfileId == umkmProfileId;
        allow update: if isUmkmOwner(umkmProfileId) && request.resource.data.umkmProfileId == resource.data.umkmProfileId; // Prevent moving product to another UMKM
        allow delete: if isUmkmOwner(umkmProfileId);
      }

      /**
       * @description Controls access to visitor insights. Private data for the UMKM owner.
       * @path /umkm_profiles/{umkmProfileId}/visitor_insights/{visitorInsightId}
       */
      match /visitor_insights/{visitorInsightId} {
        // Only the owner of the UMKM profile can read or write insights.
        allow read, write: if isUmkmOwner(umkmProfileId);
      }
    }

    /**
     * @description Controls access to minisite templates. These are public, read-only assets.
     * @path /minisite_templates/{minisiteTemplateId}
     */
    match /minisite_templates/{minisiteTemplateId} {
      allow get, list: if true;
      allow write: if false;
    }

    /**
     * @description Controls access to promotion templates. These are public, read-only assets.
     * @path /promotion_templates/{promotionTemplateId}
     */
    match /promotion_templates/{promotionTemplateId} {
      allow get, list: if true;
      allow write: if false;
    }
  }
}
